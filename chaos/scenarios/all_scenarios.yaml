# PIL Protocol Chaos Engineering Scenarios
# Test system resilience under adverse conditions
# Author: PIL Protocol Team
# Date: January 2026

scenarios:
  # Scenario 1: L1-L2 Network Partition
  - name: "L1-L2 Network Partition"
    id: "chaos-001"
    description: "Simulate complete network partition between L1 and L2"
    duration: "30m"
    severity: "critical"
    
    targets:
      - component: "optimism-bridge"
        type: "bridge-adapter"
      - component: "base-bridge"
        type: "bridge-adapter"
      - component: "arbitrum-bridge"
        type: "bridge-adapter"
    
    actions:
      - type: "network_partition"
        config:
          partition_type: "complete"
          direction: "bidirectional"
          duration: "15m"
      
      - type: "network_delay"
        config:
          latency_ms: 5000
          jitter_ms: 1000
          duration: "10m"
      
      - type: "message_drop"
        config:
          drop_rate: 0.5
          duration: "5m"
    
    expected_behavior:
      - circuit_breaker_activates: true
        max_time: "60s"
      - no_double_spend: true
      - funds_recoverable: true
      - message_queue_preserved: true
      - auto_retry_on_recovery: true
    
    recovery:
      - action: "restore_network"
      - action: "verify_state_consistency"
      - action: "process_pending_messages"

  # Scenario 2: Sequencer Downtime
  - name: "L2 Sequencer Downtime"
    id: "chaos-002"
    description: "Simulate L2 sequencer going offline"
    duration: "1h"
    severity: "high"
    
    targets:
      - component: "optimism-sequencer"
        type: "sequencer"
      - component: "base-sequencer"
        type: "sequencer"
    
    actions:
      - type: "process_kill"
        config:
          target: "sequencer"
          duration: "30m"
      
      - type: "failover_test"
        config:
          trigger_failover: true
          failover_delay: "5m"
    
    expected_behavior:
      - bridge_pauses_new_operations: true
      - pending_operations_preserved: true
      - force_inclusion_available: true
      - user_can_exit_to_l1: true
    
    recovery:
      - action: "restart_sequencer"
      - action: "sync_state"
      - action: "resume_operations"

  # Scenario 3: Oracle Price Manipulation
  - name: "Oracle Price Feed Manipulation"
    id: "chaos-003"
    description: "Test response to manipulated price feeds"
    duration: "15m"
    severity: "critical"
    
    targets:
      - component: "chainlink-oracle"
        type: "oracle"
      - component: "uniswap-twap"
        type: "oracle"
    
    actions:
      - type: "price_manipulation"
        config:
          deviation_percentage: 50
          direction: "down"
          duration: "5m"
      
      - type: "oracle_stale"
        config:
          stale_duration: "10m"
      
      - type: "oracle_conflict"
        config:
          oracle_a_price: 1000
          oracle_b_price: 500
    
    expected_behavior:
      - flash_loan_guard_activates: true
      - operations_paused: true
      - multi_oracle_validation: true
      - no_arbitrage_exploit: true
    
    recovery:
      - action: "restore_oracle_feeds"
      - action: "verify_no_losses"

  # Scenario 4: Mass Withdrawal Attack
  - name: "Mass Withdrawal Attack"
    id: "chaos-004"
    description: "Simulate coordinated mass withdrawal attempt"
    duration: "2h"
    severity: "critical"
    
    targets:
      - component: "withdrawal-queue"
        type: "queue"
      - component: "bridge-rate-limiter"
        type: "security"
    
    actions:
      - type: "mass_withdrawal"
        config:
          concurrent_withdrawals: 1000
          total_value_eth: 10000
          rate: "100/minute"
      
      - type: "gas_price_spike"
        config:
          multiplier: 10
          duration: "30m"
    
    expected_behavior:
      - rate_limiter_activates: true
      - per_user_limits_enforced: true
      - tvl_cap_respected: true
      - queue_processed_fairly: true
      - no_bank_run: true
    
    recovery:
      - action: "verify_all_withdrawals_processed"
      - action: "verify_tvl_conservation"

  # Scenario 5: Proof Verification Timeout
  - name: "Proof Verification Timeout"
    id: "chaos-005"
    description: "Test behavior when proof verification exceeds timeout"
    duration: "30m"
    severity: "medium"
    
    targets:
      - component: "groth16-verifier"
        type: "verifier"
      - component: "plonk-verifier"
        type: "verifier"
    
    actions:
      - type: "cpu_stress"
        config:
          cpu_load: 95
          duration: "15m"
      
      - type: "memory_pressure"
        config:
          memory_usage: 90
          duration: "10m"
      
      - type: "slow_verification"
        config:
          delay_ms: 30000
          timeout_ms: 10000
    
    expected_behavior:
      - timeout_handled_gracefully: true
      - retry_with_backoff: true
      - fallback_verifier_used: true
      - no_stuck_transactions: true
    
    recovery:
      - action: "release_resources"
      - action: "retry_failed_verifications"

  # Scenario 6: Byzantine Operator Attack
  - name: "Byzantine Operator Attack"
    id: "chaos-006"
    description: "Simulate malicious operator behavior"
    duration: "1h"
    severity: "critical"
    
    targets:
      - component: "bridge-operator-1"
        type: "operator"
      - component: "bridge-operator-2"
        type: "operator"
    
    actions:
      - type: "byzantine_behavior"
        config:
          attack_type: "equivocation"
          frequency: "every_10th_message"
      
      - type: "message_replay"
        config:
          replay_old_messages: true
          replay_delay: "5m"
      
      - type: "invalid_proof_submission"
        config:
          invalid_proof_rate: 0.2
    
    expected_behavior:
      - invalid_proofs_rejected: true
      - replay_attacks_blocked: true
      - byzantine_operator_slashed: true
      - honest_operators_continue: true
      - consensus_maintained: true
    
    recovery:
      - action: "slash_byzantine_operators"
      - action: "verify_state_integrity"

  # Scenario 7: MEV Attack Simulation
  - name: "MEV Sandwich Attack"
    id: "chaos-007"
    description: "Test MEV protection mechanisms"
    duration: "30m"
    severity: "high"
    
    targets:
      - component: "atomic-swap"
        type: "contract"
      - component: "bridge-operations"
        type: "contract"
    
    actions:
      - type: "frontrun_attempt"
        config:
          gas_premium: 200
          target_operations: ["swap", "withdrawal"]
      
      - type: "sandwich_attack"
        config:
          front_trade_size: 100
          back_trade_size: 100
    
    expected_behavior:
      - commit_reveal_protects: true
      - frontrun_fails: true
      - sandwich_unprofitable: true
      - user_gets_fair_price: true
    
    recovery:
      - action: "verify_no_mev_extraction"

  # Scenario 8: Flash Loan Attack
  - name: "Flash Loan Governance Attack"
    id: "chaos-008"
    description: "Test flash loan protection in governance"
    duration: "15m"
    severity: "critical"
    
    targets:
      - component: "governance"
        type: "contract"
      - component: "voting"
        type: "contract"
    
    actions:
      - type: "flash_loan_governance"
        config:
          loan_amount_eth: 100000
          vote_manipulation: true
      
      - type: "same_block_attack"
        config:
          operations_per_block: 10
    
    expected_behavior:
      - flash_loan_guard_blocks: true
      - same_block_votes_rejected: true
      - snapshot_voting_works: true
      - governance_intact: true
    
    recovery:
      - action: "verify_governance_state"

# Monitoring configuration
monitoring:
  metrics:
    - name: "circuit_breaker_state"
      type: "gauge"
      alert_on: ["DEGRADED", "HALTED"]
    
    - name: "failed_operations"
      type: "counter"
      alert_threshold: 100
    
    - name: "tvl_delta"
      type: "gauge"
      alert_threshold_percent: 10
    
    - name: "operator_slashing"
      type: "counter"
      alert_on_any: true
  
  dashboards:
    - name: "Chaos Test Dashboard"
      panels:
        - "System State"
        - "Error Rates"
        - "TVL Changes"
        - "Message Queue Depth"

# Recovery procedures
recovery_procedures:
  automatic:
    - condition: "network_restored"
      actions:
        - "sync_state"
        - "process_pending_queue"
        - "verify_consistency"
    
    - condition: "circuit_breaker_triggered"
      actions:
        - "notify_guardians"
        - "collect_forensics"
        - "await_manual_review"
  
  manual:
    - name: "Full System Recovery"
      steps:
        - "Pause all operations"
        - "Verify state consistency"
        - "Process pending messages"
        - "Verify TVL conservation"
        - "Resume operations gradually"
        - "Monitor for anomalies"
