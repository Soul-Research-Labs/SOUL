# PIL Watchtower Alert Rules
# Additional Prometheus alert rules for the anomaly detection system

groups:
  - name: watchtower_anomaly_alerts
    rules:
      # Critical: Bridge exploit detected by ML
      - alert: BridgeExploitDetected
        expr: watchtower_alerts_generated{severity="CRITICAL",alert_type="BRIDGE_EXPLOIT"} > 0
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "BRIDGE EXPLOIT DETECTED"
          description: "Watchtower {{ $labels.node_id }} detected potential bridge exploit on chain {{ $labels.chain_id }}. Confidence: {{ $value }}. Immediate action required."
          runbook_url: "https://docs.pil.network/runbooks/bridge-exploit"

      # Critical: Flash loan attack pattern
      - alert: FlashLoanAttackDetected
        expr: watchtower_alerts_generated{alert_type="FLASH_LOAN_PATTERN"} > 0
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Flash loan attack pattern detected"
          description: "Flash loan attack pattern detected by {{ $labels.node_id }} on chain {{ $labels.chain_id }}"
          runbook_url: "https://docs.pil.network/runbooks/flash-loan"

      # High: Sandwich attack
      - alert: SandwichAttackDetected
        expr: watchtower_alerts_generated{alert_type="SANDWICH_ATTACK"} > 0
        for: 0s
        labels:
          severity: high
        annotations:
          summary: "MEV sandwich attack detected"
          description: "Sandwich attack pattern detected on chain {{ $labels.chain_id }}"

      # High: Sybil attack pattern
      - alert: SybilAttackDetected
        expr: watchtower_alerts_generated{alert_type="SYBIL_ATTACK"} > 0
        for: 0s
        labels:
          severity: high
        annotations:
          summary: "Potential Sybil attack"
          description: "Unusual pattern of new addresses with high activity detected"

      # Medium: Volume anomaly
      - alert: UnusualBridgeVolume
        expr: watchtower_alerts_generated{alert_type="UNUSUAL_VOLUME"} > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Unusual bridge volume detected"
          description: "Statistical anomaly in bridge volume on chain {{ $labels.chain_id }}"

      # Medium: Timing anomaly
      - alert: TimingAnomalyDetected
        expr: watchtower_alerts_generated{alert_type="TIMING_ANOMALY"} > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Timing anomaly in transactions"
          description: "Unusual transaction timing pattern detected"

  - name: watchtower_health_alerts
    rules:
      # Watchtower node offline
      - alert: WatchtowerNodeDown
        expr: up{job="watchtower"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Watchtower node {{ $labels.instance }} is down"
          description: "Watchtower node has been unreachable for 1 minute"

      # No watchtowers active
      - alert: NoWatchtowersActive
        expr: count(up{job="watchtower"} == 1) == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "No watchtower nodes are active"
          description: "All watchtower nodes are offline. Anomaly detection is disabled."

      # Watchtower chain disconnected
      - alert: WatchtowerChainDisconnected
        expr: watchtower_chain_health == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Watchtower lost connection to chain {{ $labels.chain_id }}"
          description: "Chain {{ $labels.chain_id }} is unreachable from watchtower {{ $labels.node_id }}"

      # High detection latency
      - alert: WatchtowerHighLatency
        expr: watchtower_detection_latency_ms > 5000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High anomaly detection latency"
          description: "Detection latency is {{ $value }}ms, above 5s threshold"

      # Watchtower falling behind
      - alert: WatchtowerBlockLag
        expr: watchtower_block_lag > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Watchtower falling behind chain head"
          description: "Watchtower is {{ $value }} blocks behind chain {{ $labels.chain_id }}"

      # Circuit breaker triggered
      - alert: CircuitBreakerTriggered
        expr: watchtower_circuit_breaker_triggered > 0
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Circuit breaker triggered by watchtower"
          description: "Automatic circuit breaker triggered due to critical anomaly"

  - name: watchtower_performance_alerts
    rules:
      # High memory usage
      - alert: WatchtowerHighMemory
        expr: process_resident_memory_bytes{job="watchtower"} > 2147483648
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Watchtower high memory usage"
          description: "Watchtower using {{ $value | humanize1024 }} memory"

      # High CPU
      - alert: WatchtowerHighCPU
        expr: rate(process_cpu_seconds_total{job="watchtower"}[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Watchtower high CPU usage"
          description: "Watchtower using {{ $value | printf \"%.1f\" }}% CPU"

      # Alert backlog
      - alert: WatchtowerAlertBacklog
        expr: watchtower_pending_alerts > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alert processing backlog"
          description: "{{ $value }} alerts pending processing"

      # Redis connection issues
      - alert: WatchtowerRedisDisconnected
        expr: watchtower_redis_connected == 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Watchtower lost Redis connection"
          description: "Alert deduplication may be affected"

  - name: watchtower_detection_rates
    rules:
      # Anomaly rate spike
      - alert: AnomalyRateSpike
        expr: |
          rate(watchtower_alerts_generated[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High anomaly detection rate"
          description: "Detecting {{ $value | printf \"%.1f\" }} anomalies per second"

      # No transactions processed
      - alert: WatchtowerNotProcessing
        expr: |
          increase(watchtower_transactions_processed[10m]) == 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Watchtower not processing transactions"
          description: "No transactions processed in 10 minutes"

      # Critical alert frequency
      - alert: FrequentCriticalAlerts
        expr: |
          increase(watchtower_critical_alerts[1h]) > 5
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Multiple critical alerts in 1 hour"
          description: "{{ $value }} critical alerts in the past hour"
