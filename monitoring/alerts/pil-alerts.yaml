# PIL Critical Alerts Configuration
# Compatible with Prometheus Alertmanager

groups:
  - name: pil_critical
    rules:
      # P1 - Critical Alerts
      - alert: LargeTokenTransfer
        expr: pil_transfer_value_usd > 100000
        for: 0m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Large token transfer detected"
          description: "Transfer of {{ $value }} USD detected on {{ $labels.contract }}"
          runbook: "https://docs.pil.network/runbooks/large-transfer"

      - alert: ContractPaused
        expr: pil_contract_paused == 1
        for: 0m
        labels:
          severity: critical
          team: operations
        annotations:
          summary: "PIL Contract Paused"
          description: "Contract {{ $labels.contract }} has been paused"
          runbook: "https://docs.pil.network/runbooks/contract-paused"

      - alert: MultipleFailedProofs
        expr: rate(pil_proof_verification_failed_total[5m]) > 2
        for: 5m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "High rate of failed proof verifications"
          description: "{{ $value }} failed verifications per minute on {{ $labels.verifier }}"

      - alert: UnauthorizedRoleChange
        expr: pil_role_changes_total > 0
        for: 0m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Role change detected"
          description: "Role {{ $labels.role }} changed for {{ $labels.account }}"

  - name: pil_high
    rules:
      # P2 - High Alerts
      - alert: HighGasUsage
        expr: pil_transaction_gas_used > (pil_avg_gas_used * 3)
        for: 5m
        labels:
          severity: high
          team: engineering
        annotations:
          summary: "Abnormally high gas usage detected"
          description: "Gas usage {{ $value }} is 3x above average"

      - alert: RateLimitExceeded
        expr: rate(pil_rate_limit_hits_total[1h]) > 100
        for: 15m
        labels:
          severity: high
          team: security
        annotations:
          summary: "Rate limit frequently exceeded"
          description: "{{ $value }} rate limit hits in the past hour from {{ $labels.address }}"

      - alert: CrossChainProofDelay
        expr: pil_cross_chain_proof_age_seconds > 3600
        for: 10m
        labels:
          severity: high
          team: operations
        annotations:
          summary: "Cross-chain proof submission delayed"
          description: "Proof from chain {{ $labels.source_chain }} pending for {{ $value }}s"

      - alert: NullifierRegistryGrowth
        expr: rate(pil_nullifier_count[1h]) > 1000
        for: 30m
        labels:
          severity: high
          team: engineering
        annotations:
          summary: "Rapid nullifier registry growth"
          description: "{{ $value }} nullifiers registered per hour"

  - name: pil_medium
    rules:
      # P3 - Medium Alerts
      - alert: HighPendingTransactions
        expr: pil_pending_tx_count > 50
        for: 15m
        labels:
          severity: medium
          team: operations
        annotations:
          summary: "High pending transaction count"
          description: "{{ $value }} transactions pending"

      - alert: RelayerHealthDegraded
        expr: pil_relayer_success_rate < 0.95
        for: 10m
        labels:
          severity: medium
          team: operations
        annotations:
          summary: "Relayer success rate degraded"
          description: "Success rate at {{ $value | humanizePercentage }}"

      - alert: MerkleRootStale
        expr: time() - pil_last_merkle_root_update_timestamp > 86400
        for: 1h
        labels:
          severity: medium
          team: engineering
        annotations:
          summary: "Merkle root not updated recently"
          description: "No merkle root update in {{ $value | humanizeDuration }}"

  - name: pil_low
    rules:
      # P4 - Low Alerts
      - alert: LowRelayerBalance
        expr: pil_relayer_eth_balance < 0.5
        for: 1h
        labels:
          severity: low
          team: operations
        annotations:
          summary: "Relayer ETH balance low"
          description: "Relayer {{ $labels.address }} has {{ $value }} ETH"

      - alert: APILatencyHigh
        expr: pil_api_latency_seconds > 2
        for: 30m
        labels:
          severity: low
          team: engineering
        annotations:
          summary: "API latency above threshold"
          description: "Average latency {{ $value }}s for {{ $labels.endpoint }}"
