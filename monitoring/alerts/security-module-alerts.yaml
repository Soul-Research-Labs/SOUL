# SecurityModule Alerts Configuration
# Alerts specific to the SecurityModule security features

groups:
  - name: security_module_critical
    rules:
      # Circuit Breaker Alerts
      - alert: CircuitBreakerTripped
        expr: pil_circuit_breaker_tripped == 1
        for: 0m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Circuit breaker has tripped"
          description: "Circuit breaker tripped on {{ $labels.contract }} - volume exceeded {{ $value }} threshold"
          runbook: "https://docs.pil.network/runbooks/circuit-breaker"

      - alert: CircuitBreakerStillTripped
        expr: pil_circuit_breaker_tripped == 1
        for: 30m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Circuit breaker still tripped after 30 minutes"
          description: "Manual intervention may be required for {{ $labels.contract }}"

      # Flash Loan Attack Detection
      - alert: FlashLoanAttackDetected
        expr: rate(pil_flash_loan_blocked_total[5m]) > 5
        for: 2m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Potential flash loan attack in progress"
          description: "{{ $value }} flash loan attempts blocked per minute on {{ $labels.contract }}"
          runbook: "https://docs.pil.network/runbooks/flash-loan-attack"

      # Withdrawal Limit Alerts
      - alert: DailyWithdrawalLimitApproaching
        expr: (pil_daily_withdrawn / pil_max_daily_withdrawal) > 0.9
        for: 0m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Daily withdrawal limit 90% exhausted"
          description: "{{ $value | humanizePercentage }} of daily limit used on {{ $labels.contract }}"

      - alert: GlobalWithdrawalLimitExhausted
        expr: pil_daily_withdrawn >= pil_max_daily_withdrawal
        for: 0m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Global daily withdrawal limit exhausted"
          description: "No more withdrawals possible today on {{ $labels.contract }}"

  - name: security_module_high
    rules:
      # Rate Limiting Alerts
      - alert: RateLimitThresholdApproaching
        expr: (pil_action_count / pil_max_actions_per_window) > 0.8
        for: 5m
        labels:
          severity: high
          team: security
        annotations:
          summary: "Account approaching rate limit"
          description: "{{ $labels.account }} at {{ $value | humanizePercentage }} of rate limit"

      - alert: RateLimitHitsSpike
        expr: rate(pil_rate_limit_exceeded_total[15m]) > 10
        for: 10m
        labels:
          severity: high
          team: security
        annotations:
          summary: "Spike in rate limit hits"
          description: "{{ $value }} rate limit blocks per minute - possible DoS attempt"

      # Volume Anomaly Detection
      - alert: AbnormalVolumeSpike
        expr: pil_hourly_volume > (avg_over_time(pil_hourly_volume[24h]) * 5)
        for: 15m
        labels:
          severity: high
          team: security
        annotations:
          summary: "Abnormal volume spike detected"
          description: "Current volume {{ $value }} is 5x above 24h average"

      # Suspicious Activity Pattern
      - alert: MultipleAccountsHittingLimits
        expr: count(pil_rate_limit_exceeded_total > 0) > 10
        for: 30m
        labels:
          severity: high
          team: security
        annotations:
          summary: "Multiple accounts hitting security limits"
          description: "{{ $value }} accounts hitting limits - possible coordinated attack"

  - name: security_module_medium
    rules:
      # Configuration Change Alerts
      - alert: SecurityConfigChanged
        expr: changes(pil_security_config_hash[5m]) > 0
        for: 0m
        labels:
          severity: medium
          team: security
        annotations:
          summary: "Security configuration changed"
          description: "SecurityModule config changed on {{ $labels.contract }}"

      - alert: WithdrawalLimitsModified
        expr: changes(pil_max_single_withdrawal[5m]) > 0 or changes(pil_max_daily_withdrawal[5m]) > 0
        for: 0m
        labels:
          severity: medium
          team: security
        annotations:
          summary: "Withdrawal limits have been modified"
          description: "New limits: single={{ $labels.single_max }}, daily={{ $labels.daily_max }}"

      # Circuit Breaker Cooldown
      - alert: CircuitBreakerCooldownActive
        expr: pil_circuit_breaker_cooldown_remaining > 0
        for: 5m
        labels:
          severity: medium
          team: operations
        annotations:
          summary: "Circuit breaker in cooldown"
          description: "{{ $value }}s remaining until circuit breaker resets"

  - name: security_module_metrics
    rules:
      # Recording rules for dashboards
      - record: pil:security:flash_loan_block_rate_5m
        expr: rate(pil_flash_loan_blocked_total[5m])

      - record: pil:security:rate_limit_hit_rate_1h
        expr: rate(pil_rate_limit_exceeded_total[1h])

      - record: pil:security:withdrawal_utilization
        expr: pil_daily_withdrawn / pil_max_daily_withdrawal

      - record: pil:security:volume_to_threshold_ratio
        expr: pil_hourly_volume / pil_volume_threshold

      - record: pil:security:active_circuit_breakers
        expr: sum(pil_circuit_breaker_tripped)
