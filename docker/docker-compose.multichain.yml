version: '3.8'

# PIL Protocol - Local Multi-Chain Simulation Environment
# This docker-compose file sets up a complete local development environment
# with multiple simulated chains for cross-chain testing.

services:
  # =============================================================================
  # ETHEREUM L1 SIMULATION
  # =============================================================================
  
  ethereum-l1:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: pil-eth-l1
    ports:
      - "8545:8545"
    command: >
      anvil
      --host 0.0.0.0
      --port 8545
      --chain-id 1
      --block-time 12
      --accounts 20
      --balance 10000
      --gas-limit 30000000
      --gas-price 1000000000
    networks:
      - pil-multichain
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  # =============================================================================
  # ARBITRUM L2 SIMULATION
  # =============================================================================
  
  arbitrum-l2:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: pil-arbitrum-l2
    ports:
      - "8546:8545"
    command: >
      anvil
      --host 0.0.0.0
      --port 8545
      --chain-id 42161
      --block-time 1
      --accounts 20
      --balance 10000
      --gas-limit 100000000
      --gas-price 100000000
    networks:
      - pil-multichain
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  # =============================================================================
  # OPTIMISM L2 SIMULATION
  # =============================================================================
  
  optimism-l2:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: pil-optimism-l2
    ports:
      - "8547:8545"
    command: >
      anvil
      --host 0.0.0.0
      --port 8545
      --chain-id 10
      --block-time 2
      --accounts 20
      --balance 10000
      --gas-limit 50000000
    networks:
      - pil-multichain
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  # =============================================================================
  # BASE L2 SIMULATION
  # =============================================================================
  
  base-l2:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: pil-base-l2
    ports:
      - "8548:8545"
    command: >
      anvil
      --host 0.0.0.0
      --port 8545
      --chain-id 8453
      --block-time 2
      --accounts 20
      --balance 10000
    networks:
      - pil-multichain
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  # =============================================================================
  # PIL CONTRACT DEPLOYER
  # =============================================================================
  
  pil-deployer:
    build:
      context: ..
      dockerfile: docker/Dockerfile.hardhat
    container_name: pil-deployer
    depends_on:
      ethereum-l1:
        condition: service_healthy
      arbitrum-l2:
        condition: service_healthy
      optimism-l2:
        condition: service_healthy
      base-l2:
        condition: service_healthy
    volumes:
      - ../contracts:/app/contracts
      - ../scripts:/app/scripts
      - ../deployments:/app/deployments
    environment:
      - ETH_L1_RPC=http://ethereum-l1:8545
      - ARBITRUM_RPC=http://arbitrum-l2:8545
      - OPTIMISM_RPC=http://optimism-l2:8545
      - BASE_RPC=http://base-l2:8545
      - PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
    command: sh -c "npm run deploy:all-chains"
    networks:
      - pil-multichain

  # =============================================================================
  # PIL RELAYER SERVICE
  # =============================================================================
  
  pil-relayer:
    build:
      context: ../relayer
      dockerfile: Dockerfile
    container_name: pil-relayer
    depends_on:
      pil-deployer:
        condition: service_completed_successfully
    ports:
      - "3001:3001"
    volumes:
      - ../deployments:/app/deployments:ro
    environment:
      - NODE_ENV=development
      - ETH_L1_RPC=http://ethereum-l1:8545
      - ARBITRUM_RPC=http://arbitrum-l2:8545
      - OPTIMISM_RPC=http://optimism-l2:8545
      - BASE_RPC=http://base-l2:8545
      - RELAYER_PRIVATE_KEY=0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
      - PORT=3001
    networks:
      - pil-multichain
    restart: unless-stopped

  # =============================================================================
  # PIL PROVER SERVICE
  # =============================================================================
  
  pil-prover:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prover
    container_name: pil-prover
    ports:
      - "3002:3002"
    volumes:
      - ../circuits:/app/circuits:ro
      - ../trusted-setup:/app/trusted-setup:ro
      - prover-cache:/app/cache
    environment:
      - NODE_ENV=development
      - PROVER_PORT=3002
      - CIRCUIT_DIR=/app/circuits
      - KEYS_DIR=/app/trusted-setup/keys
    networks:
      - pil-multichain
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G

  # =============================================================================
  # GRAPH NODE (Event Indexing)
  # =============================================================================
  
  graph-node:
    image: graphprotocol/graph-node:v0.32.0
    container_name: pil-graph-node
    depends_on:
      - graph-postgres
      - graph-ipfs
      - ethereum-l1
    ports:
      - "8000:8000"  # GraphQL HTTP
      - "8001:8001"  # GraphQL WS
      - "8020:8020"  # JSON-RPC admin
      - "8030:8030"  # Indexing status
    environment:
      postgres_host: graph-postgres
      postgres_user: graph-node
      postgres_pass: letmein
      postgres_db: graph-node
      ipfs: 'graph-ipfs:5001'
      ethereum: 'mainnet:http://ethereum-l1:8545'
      GRAPH_LOG: info
    networks:
      - pil-multichain
    restart: unless-stopped

  graph-ipfs:
    image: ipfs/kubo:v0.22.0
    container_name: pil-ipfs
    ports:
      - "5001:5001"
    volumes:
      - ipfs-data:/data/ipfs
    networks:
      - pil-multichain

  graph-postgres:
    image: postgres:15
    container_name: pil-graph-postgres
    environment:
      POSTGRES_USER: graph-node
      POSTGRES_PASSWORD: letmein
      POSTGRES_DB: graph-node
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - pil-multichain

  # =============================================================================
  # MONITORING STACK
  # =============================================================================
  
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: pil-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ../monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - pil-multichain
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.2
    container_name: pil-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - ../monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ../monitoring/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - pil-multichain
    restart: unless-stopped

  # =============================================================================
  # REDIS (Caching & Message Queue)
  # =============================================================================
  
  redis:
    image: redis:7-alpine
    container_name: pil-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - pil-multichain
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  pil-multichain:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres-data:
  ipfs-data:
  prometheus-data:
  grafana-data:
  redis-data:
  prover-cache:
